#!/bin/bash

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

WORKING_HOME=/app

GHC_VER=7.6.3
CABAL_VER=1.18.0.2

S3=https://s3.amazonaws.com/heroku-ghc

mkdir -p $CACHE_DIR/download
mkdir -p $WORKING_HOME/vendor

########## GHC #####################################################
if [ ! -e $CACHE_DIR/ghc-$GHC_VER ]; then
  S3_GHC_URL=$S3/heroku-ghc-$GHC_VER.tar.gz
  if curl --output /dev/null --silent --head --fail $S3_GHC_URL; then
    echo "-----> Installing prebuilt GHC $GHC_VER"
    curl -# -L $S3_GHC_URL | tar zx -C $WORKING_HOME/vendor
  else
    echo "-----> Could not find prebuilt GHC $GHC_VER"
    if [ ! -e $CACHE_DIR/download/ghc-$GHC_VER ]; then
      GHC_URL="http://www.haskell.org/ghc/dist/$GHC_VER/ghc-$GHC_VER-x86_64-unknown-linux.tar.bz2"
      echo "-----> Downloading GHC $GHC_VER"
      curl -# -L "$GHC_URL" | bunzip2 | tar x -C $CACHE_DIR/download
    fi
    echo "-----> Installing GHC $GHC_VER"
    cd $CACHE_DIR/download/ghc-$GHC_VER
    ./configure --prefix $WORKING_HOME/vendor/ghc-$GHC_VER
    make install
  fi

  echo "-----> Caching GHC $GHC_VER binaries"
  cp -R $WORKING_HOME/vendor/ghc-$GHC_VER $CACHE_DIR
else
  echo "-----> Restoring cached GHC $GHC_VER binaries"
  rm -fr $WORKING_HOME/vendor/ghc-$GHC_VER
  cp -R $CACHE_DIR/ghc-$GHC_VER $WORKING_HOME/vendor
fi

echo "-----> Linking libgmp.so in an accessible place"
mkdir -p $WORKING_HOME/vendor/ghc-libs
ln -s /usr/lib/libgmp.so.3 $WORKING_HOME/vendor/ghc-libs/libgmp.so

export LIBRARY_PATH=$WORKING_HOME/vendor/ghc-libs:/usr/lib:$LIBRARY_PATH
export LD_LIBRARY_PATH=$LIBRARY_PATH
export PATH=$WORKING_HOME/vendor/ghc-$GHC_VER/bin:$WORKING_HOME/vendor/cabal-install-$CABAL_VER/bin:$WORKING_HOME/.cabal_sandbox/bin:$PATH

########## cabal-install ###########################################
if [ ! -e $CACHE_DIR/cabal-install-$CABAL_VER ]; then
  S3_CABAL_URL=$S3/heroku-cabal-install-$CABAL_VER.tar.gz
  if curl --output /dev/null --silent --head --fail $S3_CABAL_URL; then
    echo "-----> Installing prebuilt cabal-install $CABAL_VER"
    curl -# -L $S3_CABAL_URL | tar zx -C $WORKING_HOME/vendor
  else
    echo "-----> Could not find prebuilt cabal-install $CABAL_VER"
    if [ ! -e $CACHE_DIR/download/cabal-install-$CABAL_VER ]; then
      CABAL_URL="http://www.haskell.org/cabal/release/cabal-install-$CABAL_VER/cabal-install-$CABAL_VER.tar.gz"
      echo "-----> Downloading cabal-install $CABAL_VER"
      curl -# -L "$CABAL_URL" | tar zx -C $CACHE_DIR/download
    fi

    echo "-----> Installing cabal-install $CABAL_VER"

    cd $CACHE_DIR/download/cabal-install-$CABAL_VER
    export PREFIX=$WORKING_HOME/vendor/cabal-install-$CABAL_VER

    ./bootstrap.sh
  fi

  echo "-----> Caching cabal $CABAL_VER binaries"
  cp -R $WORKING_HOME/vendor/cabal-install-$CABAL_VER $CACHE_DIR
else
  echo "-----> Restoring cached cabal $CABAL_VER binaries"
  rm -fr $WORKING_HOME/vendor/cabal-install-$CABAL_VER
  cp -R $CACHE_DIR/cabal-install-$CABAL_VER $WORKING_HOME/vendor
fi

########## project build ###########################################

if [ -e $CACHE_DIR/.cabal_sandbox ]; then
  echo "-----> Restoring cached cabal packages"
  rm -fr $BUILD_DIR/.cabal_sandbox
  cp -R $CACHE_DIR/.cabal_sandbox $WORKING_HOME
fi

echo "-----> Getting newest list of cabal packages"
cd $WORKING_HOME
cabal update

echo "-----> Installing user application"
cd $BUILD_DIR
cabal sandbox init --sandbox $WORKING_HOME/.cabal_sandbox
cabal install -j --disable-library-profiling --disable-executable-profiling --disable-shared

echo "-----> Caching latest cabal packages"
rm -fr $CACHE_DIR/.cabal_sandbox
cp -R $WORKING_HOME/.cabal_sandbox $CACHE_DIR

echo "-----> Making GHC binaries available to Heroku command line"
mkdir -p $BUILD_DIR/vendor
mv $WORKING_HOME/vendor/ghc-libs $BUILD_DIR/vendor
mv $WORKING_HOME/vendor/ghc-$GHC_VER $BUILD_DIR/vendor
mv $WORKING_HOME/vendor/cabal-install-$CABAL_VER $BUILD_DIR/vendor

echo "-----> Making cabal sandbox available to Heroku command line"
mv $WORKING_HOME/.cabal_sandbox $BUILD_DIR
